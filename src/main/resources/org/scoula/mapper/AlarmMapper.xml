<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.scoula.mapper.AlarmMapper">

    <!-- 목록 조회: 필요한 컬럼만 선택 -->
    <select id="getAlarmList" resultType="org.scoula.dto.AlarmListDTO">
        SELECT alarm_idx, title, alarm_date, alarm_time, is_read
        FROM alarm
        WHERE users_idx = #{usersIdx}
        ORDER BY alarm_date DESC, alarm_time DESC, alarm_idx DESC
    </select>

    <!-- 상세 조회: 전체 컬럼 -->
    <select id="getAlarmDetail" resultType="org.scoula.dto.AlarmDetailDTO">
        SELECT alarm_idx, alarm_type, title, alarm_date, alarm_time, content,
               link, is_routing, is_read, users_idx
        FROM alarm
        WHERE alarm_idx = #{alarmIdx}
          AND users_idx = #{usersIdx}
    </select>

    <!-- 생성 (상세 DTO로 입력 받음) -->
    <insert id="insertDetail" parameterType="org.scoula.dto.AlarmDetailDTO"
            useGeneratedKeys="true" keyProperty="alarmIdx">
        INSERT INTO alarm
        (alarm_type, title, alarm_date, alarm_time, content, link, is_routing, is_read, users_idx)
        VALUES
            (#{alarmType}, #{title}, #{alarmDate}, #{alarmTime}, #{content},
             #{link}, #{isRouting}, #{isRead}, #{usersIdx})
    </insert>

    <update id="markRead">
        UPDATE alarm
        SET is_read = TRUE
        WHERE alarm_idx = #{alarmIdx}
          AND users_idx = #{usersIdx}
          AND is_read = FALSE
    </update>

    <update id="markAllRead">
        UPDATE alarm
        SET is_read = TRUE
        WHERE users_idx = #{usersIdx}
          AND is_read = FALSE
    </update>

    <delete id="delete">
        DELETE FROM alarm
        WHERE alarm_idx = #{alarmIdx}
          AND users_idx = #{usersIdx}
    </delete>

    <delete id="deleteAllByUser">
        DELETE FROM alarm
        WHERE users_idx = #{usersIdx}
    </delete>
</mapper>
